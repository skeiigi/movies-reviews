{% extends 'moviesApp/index.html' %}

{% block content %}
<div class="container">
  <a href="{% url 'reviews' %}">← Назад к обсуждениям</a>

  <h2>{{ review.title }}</h2>
  {% if review.movie %}
    <div style="display: flex; align-items: center;">
      {% if review.movie.poster %}
        <img src="{{ review.movie.poster.url }}" alt="{{ review.movie.title }}" style="width: 120px; height: auto; margin-right: 10px;">
      {% endif %}
      <p><strong>Фильм:</strong> {{ review.movie.title }}</p>
    </div>
  {% else %}
    <p><strong>Фильм:</strong> (не указан)</p>
  {% endif %}
  <p>{{ review.content }}</p>
  <hr>

  <h4>Комментарии</h4>

  {% for comment in comments %}
    <div style="margin-bottom: 1rem; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
      <strong><a href="{% url 'user_profile' comment.user.id %}">{{ comment.user.username }}</a></strong>: {{ comment.content }}
      <p><small>Добавлено: {{ comment.created_at|date:"d M Y, H:i" }}</small></p>
      <p><small>Последнее изменение: {{ comment.updated_at|date:"d M Y, H:i" }}</small></p>
      {% if user == comment.user %}
        <div style="margin-top: 5px;">
          <a href="{% url 'edit_comment' comment.id %}">Редактировать</a> |
          <a href="{% url 'delete_comment' comment.id %}"
             onclick="return confirm('Вы уверены, что хотите удалить комментарий?');">Удалить</a>
        </div>
      {% endif %}
      <!-- Ответы -->
      {% for reply in comment.replies.all %}
        <div style="margin-left: 20px; margin-top: 5px; padding: 8px; background: #f9f9f9; border-radius: 5px;">
          <strong><a href="{% url 'user_profile' reply.user.id %}">{{ reply.user.username }}</a></strong>: {{ reply.content }}
          <p><small>Добавлено: {{ reply.created_at|date:"d M Y, H:i" }}</small></p>
          <p><small>Последнее изменение: {{ reply.updated_at|date:"d M Y, H:i" }}</small></p>
          {% if user == reply.user %}
            <div style="margin-left: 25px; margin-top: 3px;">
              <a href="{% url 'edit_comment' reply.id %}">Редактировать</a> |
              <a href="{% url 'delete_comment' reply.id %}"
                 onclick="return confirm('Вы уверены, что хотите удалить комментарий?');">Удалить</a>
            </div>
          {% endif %}
        </div>
      {% endfor %}

      <!-- Форма ответа -->
      {% if user.is_authenticated %}
        <form method="post" action="{% url 'reply_comment' review.id comment.id %}">
          {% csrf_token %}
          {{ form.as_p }}
          <button type="submit">Ответить</button>
        </form>
      {% else %}
        <p>
          Чтобы ответить, <a href="{% url 'login' %}">войдите в аккаунт</a>.
        </p>
      {% endif %}
    </div>
  {% empty %}
    <p>Комментариев пока нет.</p>
  {% endfor %}

  <hr>
  <h5>Оставить комментарий:</h5>
  {% if user.is_authenticated %}
    <form method="post" action="{% url 'add_comment' review.id %}">
      {% csrf_token %}
      {{ form.as_p }}
      <button type="submit">Добавить комментарий</button>
    </form>
  {% else %}
    <p>
      Чтобы оставить комментарий, <a href="{% url 'login' %}">войдите в аккаунт</a>.
    </p>
  {% endif %}
</div>
{% endblock %}